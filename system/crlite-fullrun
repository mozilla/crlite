#!/bin/bash -e

if [ "x${credentials_data}x" != "xx" ] ; then
  echo "Using the credentials_data evironment variable for GOOGLE_APPLICATION_CREDENTIALS"
  echo "${credentials_data}" | base64 --decode >> /tmp/credentials.json
  export GOOGLE_APPLICATION_CREDENTIALS=/tmp/credentials.json
fi

if [ "x${GOOGLE_APPLICATION_CREDENTIALS}x" == "xx" ] ; then
  echo "You'll need to provide GOOGLE_APPLICATION_CREDENTIALS somehow"
  echo "because all the scripts depend on it. Maybe you should also set"
  echo "DoNotUpload to something, to avoid uploading accidentally?"
  exit 1
fi

workflow=${crlite_workflow:-~/go/src/github.com/mozilla/crlite/workflow}

# TODO: renumber
# TODO: port to firestore
#${workflow}/6-cleanup-expired-ct-folders --path ${crlite_ctdata:-/ct}

if [ "x${reprocess_certs}x" == "xtruex" ]; then
  ${workflow}/0-reprocess_certs
elif [ "x${fetch_certs}x" == "xtruex" ]; then
  ${workflow}/1-ct-fetch
else
  ID=$(${workflow}/0-allocate_identifier --path ${crlite_processing:-/ct/processing/})
  echo "Allocated ${ID}"

  ulimit -a

  ${workflow}/2-produce_revocation_data ${ID}
  ${workflow}/3-produce_known_data ${ID}

  echo "crlite-fullrun: list known folder"
  ls -latS ${ID}/known | head
  echo "crlite-fullrun: list revoked folder"
  ls -latS ${ID}/revoked | head
  echo "crlite-fullrun: disk usage"
  du -hc ${ID}

  ${workflow}/4-generate_mlbf ${ID}

  if [ "x${DoNotUpload}x" == "xx" ] ; then
    ${workflow}/8-upload_artifacts_to_storage ${ID}
  fi

  # ${workflow}/7-cleanup-expired-processing-folders --keep 1 --path ${crlite_processing:-/ct/processing}
  # TODO: Cleanup CRL folders

  echo "crlite_processing"
  df ${crlite_processing:-/ct/processing}
  echo "crlite_persistent"
  df ${crlite_persistent:-/ct/}

  if [ "x${KINTO_AUTH_USER}x" != "xx" ]; then
    ${workflow}/5-upload_intermediates ${ID}
    ${workflow}/5-upload_mlbf_to_kinto ${ID}
  fi
fi
